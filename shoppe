#!/bin/bash
# shellcheck disable=SC2219,SC2001,SC2164,SC2086
# shoppe by knuxify
version="0.1"
debug=true
arch="x86_64"

# Colors
color() {
	case $1 in
		0) printf "\033[30m";;
		1) printf "\033[31m";;
		2) printf "\033[32m";;
		3) printf "\033[33m";;
		4) printf "\033[34m";;
		5) printf "\033[35m";;
		6) printf "\033[36m";;
		7) printf "\033[37m";;
		r) printf "\033[0m";;
	esac
}
infoPrefix="$(color 4)||$(color r)"
warnPrefix="$(color 3)~!$(color r)"
errorPrefix="$(color 1)!!$(color r)"
debugPrefix="$(color 5)~~$(color r)"
debugprint() {
	if [ "$debug" = "true" ]; then
		echo -e "$debugPrefix $*"
	fi
}

debugprint "shoppe version $version"
echo -e "$warnPrefix shoppe is work-in-progress alpha software! Feel free to help out by submitting issues and adding your own code. See TODO for things to do."
# Don't run shoppe as root!
if [ "$EUID" -eq 0 ]; then echo -e "$errorPrefix Don't run shoppe as root!"; exit 4; fi

configdir="$HOME/.config/shoppe"
repofile="$configdir/repos"
configfile="$configdir/config"
packagefile="$configdir/packages"
packinfodir="$configdir/packinfo"
tmpdir="$configdir/tmp"

# Create shoppe files
if ! [ -e "$configdir" ]; then mkdir -p "$configdir"; fi
if ! [ -e "$repofile" ]; then echo "GithubRepo=knuxify/shoppe-repos" > "$repofile"; fi
if ! [ -e "$packinfodir" ]; then mkdir "$packinfodir"; fi

# TODO package managers
unsupportedManagers="emerge nix-env"

# Detect currently installed package managers
supportedManagers="pkg apt apt-get yum dnf pacman yaourt pacaur yay apk eopkg zypper"

for pm in $supportedManagers; do
	if command -v "$pm" &>/dev/null; then
		installed="$installed $pm"
		debugprint "Found $pm."
	fi
done

for pm in $unsupportedManagers; do
	if command -v "$pm" &>/dev/null; then
		echo -e "$warnPrefix Detected a known but unsupported package manager: $pm."
		echo -e "$warnPrefix It might be added in a later update."
	fi
done

# Helper functions.
success() {
	echo "$infoPrefix Success!"
	# shellcheck disable=SC2154
	if [ -z "$name" ]; then exit 0; else let success++; currentsuccess="1"; fi
}

yesno() {
	choice=null
	until [ "$choice" = "y" ] || [ "$choice" = "Y" ] || [ "$choice" = "n" ] || [ "$choice" = "N" ]; do
		read -ren1 choice
		if [ -z "$choice" ]; then choice="$1"; fi
	done
	if [ "$choice" = "Y" ] || [ "$choice" = "y" ]; then choice="yes"; else choice="no"; fi
}

# For shoppepkg
getpkg() {
	# shellcheck disable=SC2154
	case $sourcetype in
		git) mkdir "$name"; git clone "$source" "$name";;
		git-tag) mkdir "$name"; git clone --branch "$tag" "$source" "$name";;
		compressed) mkdir "$name"; cd "$name"; wget "$source"; tar xzf ./*; cd ..;;
	esac
}

# Functions: Install, remove, update, upgrade.
# Future functions: fetch, find, info.

pinstall() {
	if [ -z "$packages" ]; then echo -e "$errorPrefix Nothing to install!"; exit 2; fi
	for pm in $installed; do
		echo -e "$infoPrefix Using $pm..."
		case $pm in
			apt|apt-get|yum|dnf|eopkg|zypper) sudo "$pm" install $packages $switches && success;;
			pkg) "$pm" install $packages $switches && success;;
			pacman) sudo "$pm" -S $packages $switches && success;;
			yaourt|yay) "$pm" -S $packages $switches && success;;
			apk) sudo "$pm" add $packages $switches && success;;
		esac
		echo -e "$warnPrefix $pm failed."
	done
	echo -e "$infoPrefix Searching on shoppe repos..."
	for package in $packages; do
		if grep "$package" "$packagefile" &>/dev/null; then
			echo "$package is already installed! Install anyways? [y/N]"
			yesno n
			if [ "$choice" = "no" ]; then continue; else alreadyinstalled="true"; fi
		fi
		while IFS="" read -r repo || [ -n "$repo" ]; do
			# shellcheck disable=SC1083,SC2086
			case $repo in
				GithubRepo=*) response="$(curl --write-out %{http_code} --silent --output /dev/null https://raw.githubusercontent.com/${repo/GithubRepo=/}/master/$arch/$package/shoppepkg)"; if [ "$response" = "200" ]; then echo -e "$infoPrefix Found $package in repository ${repo/GithubRepo=/}."; toshoppe="$toshoppe $package"; tsrepos="$tsrepos $repo"; tsarch="$tsarch all"; fi;;
			esac
		done < "$repofile"
		toshoppe=$(echo "$toshoppe" | sed -e 's/^[ \t]*//')
		while IFS="" read -r repo || [ -n "$repo" ]; do
			# shellcheck disable=SC1083,SC2086
			case $repo in
				GithubRepo=*) response="$(curl --write-out %{http_code} --silent --output /dev/null https://raw.githubusercontent.com/${repo/GithubRepo=/}/master/all/$package/shoppepkg)"; if [ "$response" = "200" ]; then echo -e "$infoPrefix Found $package in repository ${repo/GithubRepo=/}."; toshoppe="$toshoppe $package"; tsrepos="$tsrepos $repo"; tsarch="$tsarch all"; fi;;
			esac
		done < "$repofile"
	done
	toshoppe=$(echo "$toshoppe" | sed -e 's/^[ \t]*//')
	tsrepos=$(echo "$tsrepos" | sed -e 's/^[ \t]*//')
	tsarch=$(echo "$tsarch" | sed -e 's/^[ \t]*//')
	if [ -z "$toshoppe" ]; then
		echo -e "$errorPrefix Failed to install some packages. Double check your spelling."
		exit 1
	else
		currentpack=0
		success=0
		currentsuccess=0
		for package in $toshoppe; do
			if [ -e "$tmpdir" ]; then rm -rf "$tmpdir"; fi
			mkdir "$tmpdir"
			echo -e "$infoPrefix Installing $package..."
			let currentpack++
			echo -e "$infoPrefix Fetching package..."
			currentrepo=1
			for repo in $tsrepos; do
				if ! [ "$currentrepo" -eq "$currentpack" ]; then
					let currentrepo++
				else
					getrepo="$repo"
				fi
			done
			currentarch=1
			for archt in $tsarch; do
				if ! [ "$currentarch" -eq "$currentpack" ]; then
					let currentarch++
				else
					getarch="$archt"
				fi
			done
			case $getrepo in
				GithubRepo=*) wget -q https://raw.githubusercontent.com/"${getrepo/GithubRepo=/}"/master/"$getarch"/"$package"/shoppepkg -O "$tmpdir"/shoppepkg;;
			esac
			cd "$tmpdir"
			source shoppepkg
			if type -t shoppebuild &>/dev/null; then
				echo -e "$infoPrefix Buidling..."
				shoppebuild
			fi
			echo -e "$infoPrefix Installing..."
			shoppeinstall
			sudo cp -rf "$tmpdir"/content/* /
			cd "$tmpdir/content"
			find ./ -type f | cut -c2-  > $packinfodir/$name
			if [ "$currentsuccess" = "1" ] && ! [ "$alreadyinstalled" = "true" ]; then
				echo "$name" >> $packagefile
			fi
		done
	fi
	if ! [ "$success" = "$currentpack" ]; then
		echo -e "$errorPrefix Failed to install some packages. Double check your spelling."
		exit 1
	else
		echo -e "$infoPrefix Installed succesfully."
		exit 0
	fi
}

premove() {
	if [ -z "$packages" ]; then echo -e "$errorPrefix Nothing to remove!"; exit 2; fi
	for pm in $installed; do
		echo -e "$infoPrefix Using $pm..."
		case $pm in
			apt|apt-get|yum|dnf|eopkg|zypper) sudo "$pm" remove $packages $switches && success;;
			pkg) "$pm" remove $packages $switches && success;;
			pacman) sudo "$pm" -R $packages $switches && success;;
			yaourt|yay) "$pm" -R $packages $switches && success;;
			apk) sudo "$pm" del $packages $switches && success;;
		esac
		echo -e "$warnPrefix $pm failed."
	done
	currentpack="0"
	for package in $packages; do
		let currentpack++
		if grep "$package" "$packagefile" &>/dev/null; then
			echo -e "$infoPrefix Removing package $package..."
			xargs sudo rm -f < "$packinfodir/$package"
			grep -v "$package" "$packagefile" > "$packagefile"-tmp
			mv -f "$packagefile"-tmp "$packagefile"
			rm "$packinfodir/$package"
			name="$package"
			success
			name=""
		fi
	done
	if ! [ "$success" = "$currentpack" ]; then
		echo -e "$errorPrefix Failed to remove some packages. Double check your spelling."
		exit 1
	else
		echo -e "$infoPrefix Removed succesfully."
		exit 0
	fi
}

pupdate() {
	for pm in $installed; do
		echo -e "$infoPrefix Using $pm..."
		case $pm in
			apt|apt-get|yum|dnf|eopkg|zypper|apk) sudo "$pm" update "$switches" && success;;
			pkg) "$pm" update "$switches" && success;;
			pacman) sudo "$pm" -Sy "$switches" && success;;
			yaourt|yay) "$pm" -Sy "$switches" && success;;
		esac
		echo -e "$warnPrefix $pm failed."
	done
	echo -e "$errorPrefix Repo update failed."
}


pupgrade() {
	for pm in $installed; do
		echo -e "$infoPrefix Using $pm..."
		case $pm in
			apt|apt-get|yum|dnf|eopkg|zypper|apk) sudo "$pm" upgrade $packages $switches && success;;
			pkg) "$pm" upgrade $packages $switches && success;;
			pacman) sudo "$pm" -Syu $packages $switches && success;;
			yaourt|yay) "$pm" -Syu $packages $switches && success;;
		esac
		echo -e "$warnPrefix $pm failed."
	done
	echo -e "$errorPrefix Upgrade failed."
}

# Parse options.
for parse in "$@"; do
	case $parse in
		'install') command="install";;
		'remove') command="remove";;
		'update') command="update";;
		'upgrade') command="upgrade";;
#		'fetch') command="fetch";;
#		'find') command="find";;
#		'info') command="info";;
		-*) switches="$switches $parse";;
#		+*) shoppeswitches="$shoppeswitches $parse";;
		*) packages="$packages $parse";;
	esac
done
command=$(echo "$command" | sed -e 's/^[ \t]*//')
packages=$(echo "$packages" | sed -e 's/^[ \t]*//')
switches=$(echo "$switches" | sed -e 's/^[ \t]*//')
debugprint "$command $packages [$switches]"
# Execute required command
#shellcheck disable=SC2086
p$command
